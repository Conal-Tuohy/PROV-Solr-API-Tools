<!DOCTYPE html>
<html>
	<head>
		<title>PROV API Query Builder</title>
		<link rel="stylesheet" href="api-query-builder-form.css"> 
	</head>
	<body>
		<!-- this JavaScript library contains functions to connect an HTML5 form to a Solr server -->
		<script src="api-query-builder-form.js"></script>
		<!-- NB The id attribute used in this page are arbitrary and bear no necessary relation to Solr field names. -->
		<!-- This allows multiple instances of a form to embedded in a single page without conflicting. -->
		<h1>PROV API Query Builder Form</h1>
		<!-- The form's id ("my-query-builder-form") is used to identify the form to JS functions below -->
		<!-- The form's action attribute specifies the base URL of the Solr API -->
		<form id="my-query-builder-form" action="/search/query" class="query-builder">
			<!-- Elements with the class "metadata" correspond to Solr fields. -->
			<!-- Each such input should have a name attribute which matches the name of a Solr field -->
			<fieldset class="metadata">
				<legend>Metadata fields</legend>
				<div>
					<label for="text-input">Text</label>
					<input id="text-input" name="text" type="text" class="metadata">
				</div>
				<div>
					<label for="series-input">Series</label>
					<input id="series-input" name="series_id" list="series-list" class="metadata">
					<!-- A datalist element will be populated by options with values taken from facet buckets of the corresponding Solr field -->
					<!-- This datalist will be populated with option elements whose value attributes will be drawn from the Solr field "is_part_of_series.id" -->
					<datalist id="series-list">
					</datalist>
				</div>
				<div>
					<label for="record-form-select">Record form</label>
					<select id="record-form-select" name="record_form" class="metadata" multiple>
						<!-- No option elements are specified, so the JS initialization will load facets from Solr -->
					</select>
				</div>
				<div>
					<label for="start_dt-input">Start date</label>
					<!-- TODO do I need class="from"/"to"? Can't the query-builder work out which is which based on the data entered? -->
					<input id="start_dt-input" name="start_dt" type="date" min="1800-01-01" class="metadata">
				</div>
				<div>
					<label for="end_dt-input">End date</label>
					<input id="end_dt-input" name="end_dt" type="date" min="1800-01-01" class="metadata">
				</div>
				<div>
					<label for="iiif-manifest-input">IIIF manifest</label>
					<input id="iiif-manifest-input" type="checkbox" name="iiif-manifest" value="*" class="metadata"/>
				</div>
			</fieldset>
			<fieldset>
				<legend>Output options</legend>
				<div>
					<label for="sort-select">Sort order</label>
					<select id="sort-select" name="sort" class="control">
						<option label="Score (default)"></option>
						<option label="Series title">Series_title asc</option>
						<option label="PROV ACM identifier">identifier.PROV_ACM.id asc</option>
					</select>
				</div>
				<div>
					<label for="output-format-select">Output format</label>
					<select id="output-format-select" name="wt" class="control">
						<option label="CSV">csv</option>
						<option label="JSON">json</option>
						<option label="XML">xml</option>
						<option label="IIIF">xslt</option>
					</select>
					<!-- when XSLT is requested, a stylesheet must be specified -->
					<input type="hidden" name="tr" class="control" value="solr-to-iiif.xsl">
					<!-- when CSV is requested, if any fields have multiple values, separate them with "|" rather than a comma -->
					<input type="hidden" name="csv.mv.separator" class="control" value="|">
				</div>
				<div>
					<label for="rows-input">Number of rows</label>
					<input class="control" name="rows" id="rows-input" type="number" min="1" max="200">
				</div>
				<div>
					<label for="start-input">Starting at row</label>
					<input class="control" name="start" id="start-input" type="number" min="0">
				</div>
				<div>
					<button name="search" type="submit">Search</button>
					<button name="download" type="submit">Download</button>
				</div>
			</fieldset>
			<fieldset>
				<legend>Results</legend>
				<p>Query URL: <a id="query-url-display" class="display-url" href="">(click the <string>Search</string> button to generate the URL)</a></p>
				<iframe name="my-query-builder-form-results" id="my-query-builder-form-results" src="about:blank" style="box-sizing: border-box; width: 100%; height: 20em; background-color: white;">
				</iframe>
			</fieldset>
		</form>
		<!-- automate the query builder form -->
		<script>
			// When the user submits the query builder form, the form will emit a "urlChanged" event. 
			// By adding a function to listen for this event, we can receive the updated query URL.
			function handleSolrUrlChange(event) {
				const queryUrlDisplay = document.getElementById('query-url-display');
				if (event.detail.submitter.name === "download") {
					// the user has chosen to download the query results
					// so we set the "query-url-display" hyperlink to point to the query results, specify the download name, and click it,
					// before putting it back the way it was
					var downloadLink = document.createElement("a");
					downloadLink.href = event.detail.url;
					downloadLink.download = event.detail.downloadFilename;
					downloadLink.click();
				} else { 
					// update the "query-url-display" link so that it displays (and links to) the query URL produced by the form
					queryUrlDisplay.innerText = event.detail.url;
					queryUrlDisplay.href = event.detail.url;
					// update the "my-query-builder-form-results" iframe so that it displays the query results
					document.getElementById('my-query-builder-form-results').src= event.detail.url;
				}
			};
			const form = document.getElementById('my-query-builder-form');
			form.addEventListener('urlChanged', handleSolrUrlChange);
		</script>
	</body>
</html>